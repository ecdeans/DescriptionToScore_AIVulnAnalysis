import openai
import csv

# Set up OpenAI API creds
openai.api_key = 'YOUR-API-KEY'

def generate_openai_score(cve_description):
    """
    Takes a CVE description and generates a CVSS v3.1 scoree using OpenAI.
    """
    prompt = f"""
    The following is a description of a CVE vulnerability. Based on the description, provide a CVSS v3.1 base score for the vulnerability.
    Your response should be only the numeric base score, and no additional commentary.

    CVE Description:
    {cve_description}

    Please respond with ONLY the CVSS base score:
    """

    response = openai.Completion.create(
        model="gpt-4",  
        prompt=prompt,
        max_tokens=50,  # Shorter response
        temperature=0.2,  # Lower temperature for more deterministic outputs
        n=1  
    )

    # Extract the generated text (the score) from the response
    generated_text = response.choices[0].text.strip()

    try:
        # Get the score
        score = float(generated_text)
    except ValueError:
        score = None

    return score


def process_csv(input_filename, output_filename):
    """
    Process the input CSV and append the OpenAI score to each row, then save it to the output CSV.
    """
    with open(input_filename, mode='r', newline='', encoding='utf-8') as infile:
        csv_reader = csv.reader(infile)
        header = next(csv_reader)  # Read the header

        # Add the new column header for AI score
        header.append('OpenAI Score')

        # Adding new column
        rows = []
        for row in csv_reader:
            cve_description = row[1]  
            openai_score = generate_openai_score(cve_description)
            row.append(openai_score)  
            rows.append(row)

    # Write the new data into the output CSV
    with open(output_filename, mode='w', newline='', encoding='utf-8') as outfile:
        csv_writer = csv.writer(outfile)
        csv_writer.writerow(header)  # Write header
        csv_writer.writerows(rows)  # Write data rows
c

if __name__ == "__main__":
    # Add input filename here
    input_filename = ''
    output_filename = 'withAIScores.csv'

    # Process the CSV
    process_csv(input_filename, output_filename)
    print(f"Output saved to {output_filename}")
